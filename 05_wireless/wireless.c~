#include "USART.h"
#include <util/delay.h>
#define SSID "biju_and_me"
#define PASS "bijuaydcac"
#define DST_IP "220.181.111.85" //baidu.com
void setup()
{
     // Open serial communications and wait for port to open:
     initUSART();
     //test if the module is ready
		 printString("----- ESP8266 Demo ------\r\n");
     _delay_ms(1000);
     /*if(readString("ready"))
     {
				cerr << "module is ready" ;
     }
     else
     {
				cerr << "Module have no response." ;
       while(1);
     }*/
     _delay_ms(1000);
     //connect to the wifi
     int connected=0;
     for(int i=0;i<5;i++)
     {
       if(connectWiFi())
       {
         connected = 1;
         break;
       }
     }
     if (!connected){while(1);}
     _delay_ms(5000);
     //print the ip addr
     /*Serial.println("AT+CIFSR");
     dbgSerial.println("ip address:");
     while (Serial.available())
     dbgSerial.write(Serial.read());*/
     //set the single connection mode
     printString"AT+CIPMUX=0");
   }
   void loop()
   {
     String cmd = "AT+CIPSTART=\"TCP\",\"";
     cmd += DST_IP;
     cmd += "\",80";
     printString(cmd);
     //dbgSerial.println(cmd);
     //if(Serial.find("Error")) return;
     cmd = "GET / HTTP/1.0\r\n\r\n";
     printString("AT+CIPSEND=");
     printStirng(cmd.length());
     /*if(Serial.find(">"))
     {
       dbgSerial.print(">");
       }else
       {
         Serial.println("AT+CIPCLOSE");
         dbgSerial.println("connect timeout");
         _delay_ms(1000);
         return;
       }*/
       printString(cmd);
       _delay_ms(2000);
       //Serial.find("+IPD");
       while (Serial.available())
       {
         char c = receiveByte();
				 transmitByte(c);
         //dbgSerial.write(c);
         //if(c=='\r') dbgSerial.print('\n');
       }
       //dbgSerial.println("====");
       _delay_ms(1000);
     }
     boolean connectWiFi()
     {
       printString("AT+CWMODE=1");
       String cmd="AT+CWJAP=\"";
       cmd+=SSID;
       cmd+="\",\"";
       cmd+=PASS;
       cmd+="\"";
       //dbgSerial.println(cmd);
       printString(cmd);
       _delay_ms(2000);
       /*if(Serial.find("OK"))
       {
         dbgSerial.println("OK, Connected to WiFi.");
         return true;
         }else
         {
           dbgSerial.println("Can not connect to the WiFi.");
           return false;
         }*/
       }
